# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on: workflow_dispatch
  # push:
  #   branches:
  #     - main
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
      - uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28
          add-to-path: true
      # - name: Cache GEOS
      #   uses: actions/cache@v4
      #   with:
      #     path: /home/runner/build/x86_64-linux-android/
      #     key: geos-3.13.1

      - name: download requirements
        run: |
          export TARGET=x86_64-linux-android
          export BUILD="/home/runner/build-${TARGET}"
          export NDK=/opt/hostedtoolcache/ndk/r28/x64
          export TOOLCHAIN=${NDK}/toolchains/llvm/prebuilt/linux-x86_64
          export API=28
          export AR=$TOOLCHAIN/bin/llvm-ar
          export CC="$TOOLCHAIN/bin/clang --target=$TARGET$API"
          export AS=$CC
          export CXX="$TOOLCHAIN/bin/clang++ --target=$TARGET$API"
          export LD=$TOOLCHAIN/bin/ld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          export CFLAGS="${CFLAGS} -I${BUILD}/include/"
          export LDFLAGS="${LDFLAGS} -L${BUILD}/lib/ -lm"
          sudo apt install -y autotools-dev autoconf libtool

          echo Build ICU
          wget -q https://github.com/unicode-org/icu/releases/download/release-77-1/icu4c-77_1-src.tgz
          tar xzf icu4c-77_1-src.tgz
          cd icu
          cd ..
          
          echo BUILD LIBICONV
          wget -q https://ftp.gnu.org/pub/gnu/libiconv/libiconv-1.18.tar.gz
          tar xzf libiconv-1.18.tar.gz
          cd libiconv-1.18
          ./configure --host=x86_64 --prefix=${BUILD} --with-sysroot=${NDK}/toolchains/llvm/prebuilt/linux-x86_64/sysroot
          make install

          echo Build GEOS
          wget -q https://download.osgeo.org/geos/geos-3.13.1.tar.bz2
          bzip2 -d < geos-3.13.1.tar.bz2 | tar xf -
          cd geos-3.13.1
          ./configure --prefix=${BUILD}
          make install
          cd ..

          echo Build LIBTROPO
          wget -q https://github.com/CGX-GROUP/librttopo/archive/refs/tags/librttopo-1.1.0.tar.gz
          tar xzf librttopo-1.1.0.tar.gz
          cd librttopo-librttopo-1.1.0
          ./autogen.sh
          ./configure --host=x86_64 --with-geosconfig=${BUILD}/bin/geos-config --prefix=${BUILD}
          make install
          cd ..          
          
          echo Build LIBSQLITE3
          wget -q https://www.sqlite.org/2025/sqlite-src-3500000.zip
          unzip -q sqlite-src-3500000.zip
          cd sqlite-src-3500000
          ./configure --prefix=${BUILD}
          make install
          cd ..

          wget -q https://gitlab.gnome.org/GNOME/libxml2/-/archive/v2.14.3/libxml2-v2.14.3.tar.gz
          tar xzf libxml2-v2.14.3.tar.gz

          
          ls -lR ${BUILD}
          echo Build LIBSPATIALITE
          wget -q https://www.gaia-gis.it/gaia-sins/libspatialite-sources/libspatialite-5.1.0.tar.gz
          tar xzf libspatialite-5.1.0.tar.gz
          cd libspatialite-5.1.0
          ./configure --prefix=${BUILD} --enable-proj=no --enable-freexl=no --enable-minizip=no --enable-module-only --enable-examples=no --host=x86_64 --with-geosconfig=${BUILD}/bin/geos-config --with-sysroot=${NDK}/toolchains/llvm/prebuilt/linux-x86_64/sysroot 
          make install
