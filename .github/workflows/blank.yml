# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  push:
    branches:
      - main
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r28
          add-to-path: true

      - name: download requirements
        run: |
          export TARGET=x86_64-linux-android
          export NDK=/opt/hostedtoolcache/ndk/r28/x64
          export TOOLCHAIN=${NDK}/toolchains/llvm/prebuilt/linux-x86_64
          export API=28
          export AR=$TOOLCHAIN/bin/llvm-ar
          export CC="$TOOLCHAIN/bin/clang --target=$TARGET$API"
          export AS=$CC
          export CXX="$TOOLCHAIN/bin/clang++ --target=$TARGET$API"
          export LD=$TOOLCHAIN/bin/ld
          export RANLIB=$TOOLCHAIN/bin/llvm-ranlib
          export STRIP=$TOOLCHAIN/bin/llvm-strip

          wget -q https://www.sqlite.org/2025/sqlite-src-3500000.zip
          unzip -q sqlite-src-3500000.zip
          cd sqlite-src-3500000
          ./configure --prefix=/tmp/libsqlite3-${TARGET}
          make install
          cd ..
          
          wget -q https://download.osgeo.org/geos/geos-3.13.1.tar.bz2
          bzip2 -d < geos-3.13.1.tar.bz2 | tar xf -
          cd geos-3.13.1
          ./configure --prefix=/tmp/geos-${TARGET}
          make install
          cd ..

          export CFLAGS="${CFLAGS} -I/tmp/libsqlite3-${TARGET}/include/"
          wget -q https://www.gaia-gis.it/gaia-sins/libspatialite-sources/libspatialite-5.1.0.tar.gz
          tar xzf libspatialite-5.1.0.tar.gz
          cd libspatialite-5.1.0
          ./configure --prefix=/tmp/libspatialite-${TARGET} --enable-proj=no --enable-freexl=no --enable-minizip=no --enable-module-only --enable-examples=no --host=x86_64 --with-sysroot=${NDK}/toolchains/llvm/prebuilt/linux-x86_64/sysroot --with-geosconfig=/tmp/geos-${TARGET}/bin/geos-config --enable-shared=yes --enable-static=yes
          

